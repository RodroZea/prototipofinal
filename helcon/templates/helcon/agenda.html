{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Agendar Cita</title>

  <!-- Google Fonts: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />

  <style>
    :root {
      --oxford-blue: #0b1d3a;
      --oxford-blue-light: #1e335c;
      --oxford-blue-lighter: #40559b;
      --beige: #fdf6ee;
      --beige-dark: #f5e8d9;
      --text-color: #333;
      --white: #ffffff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      font-family: 'Poppins', sans-serif;
      background: var(--beige);
      color: var(--text-color);
      height: 100%;
    }

    h1, h2 {
      text-align: center;
      color: var(--oxford-blue);
      margin: 30px 0 20px;
    }

    .container {
      max-width: 1100px;
      margin: 30px auto;
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      padding: 40px;
    }

    .btn-group {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }

    .btn-group button {
      padding: 12px 30px;
      background-color: var(--oxford-blue);
      color: var(--white);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }

    .btn-group button:hover {
      background-color: var(--oxford-blue-light);
    }

    .form-section {
      background: var(--beige-dark);
      border-radius: 12px;
      padding: 30px;
      display: none;
      margin-bottom: 40px;
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 5px;
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 1.5px solid var(--oxford-blue-light);
      border-radius: 8px;
      background: var(--white);
      font-size: 1rem;
    }

    input:focus, textarea:focus {
      border-color: var(--oxford-blue-lighter);
      outline: none;
    }

    button[type="submit"] {
      background-color: var(--oxford-blue-lighter);
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 1.05rem;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button[type="submit"]:hover {
      background-color: var(--oxford-blue-light);
    }

    .calendar-wrapper {
      margin-top: 40px;
      background: var(--white);
      border: 1px solid var(--oxford-blue-light);
      border-radius: 12px;
      padding: 30px;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
    }

    #calendar {
      background-color: var(--white);
      border-radius: 10px;
      padding: 20px;
    }

    /* Estilo de eventos en calendario */
    .fc-daygrid-event {
      background-color: var(--oxford-blue-lighter);
      color: white;
      border-radius: 4px;
      padding: 2px 4px;
      font-size: 0.85rem;
      overflow-wrap: break-word;
    }
  </style>
</head>
<body>

  <h2>¿Para quién es la cita?</h2>
  <div class="btn-group">
    <button type="button" onclick="seleccionarModo('mi')">Registrar para mí</button>
    <button type="button" onclick="seleccionarModo('otra')">Registrar para otra persona</button>
  </div>

  <h2>Agendar con Dr. {{ doctor.user.first_name }} {{ doctor.user.last_name }}</h2>

  <div class="container">
    <div class="form-wrapper">
      <form method="POST" action="{% url 'agenda' doctor.id %}">
        {% csrf_token %}
        <div class="form-section" id="formDatos">

          <label>Nombre:</label>
          <input type="text" name="nombre" id="nombre" required>

          <label>Fecha de nacimiento:</label>
          <input type="date" name="fecha_nacimiento" id="fecha_nacimiento" required>

          <label>Cédula:</label>
          <input type="text" name="cedula" id="cedula" required>

          <label>Teléfono:</label>
          <input type="tel" name="telefono" id="telefono" required>

          <div id="campoCorreo">
            <label>Correo:</label>
            <input type="email" name="correo" id="correo">
          </div>

          <label>Datos de la consulta:</label>
          <textarea name="datos_consulta" id="datos_consulta" rows="3" required></textarea>

          <label>Motivo de la visita:</label>
          <textarea name="motivo_visita" id="motivo_visita" rows="2" required></textarea>

          <label>Aseguradora:</label>
          <input type="text" name="aseguradora" id="aseguradora" required>

          <label>Hora de la cita (HH:mm):</label>
          <input type="time" name="horacita" id="horacita" required>

          <label>Fecha de la cita:</label>
          <input type="date" name="fecha_cita" id="fecha_cita" required>

          <button type="submit">Enviar cita</button>
        </div>
      </form>
    </div>

    <div class="calendar-wrapper">
      <div id="calendar"></div>
    </div>
  </div>

  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script>
    const pacienteData = {
      nombre: "{{ paciente.user.first_name|default:''|escapejs }}",
      apellido: "{{ paciente.user.last_name|default:''|escapejs }}",
      fecha_nacimiento: "{{ paciente.birthdate|date:'Y-m-d'|default:'' }}",
      cedula: "{{ paciente.id_number|default:''|escapejs }}",
      telefono: "{{ paciente.phone|default:''|escapejs }}",
      fecha_cita: "{{ paciente.fecha_cita|date:'Y-m-d'|default:'' }}",
      correo: "{{ paciente.user.email|default:''|escapejs }}"
    };

    function seleccionarModo(modo) {
      const form = document.getElementById("formDatos");
      const campoCorreoDiv = document.getElementById("campoCorreo");

      const campos = {
        nombre: document.getElementById("nombre"),
        fecha_nacimiento: document.getElementById("fecha_nacimiento"),
        cedula: document.getElementById("cedula"),
        telefono: document.getElementById("telefono"),
        fecha_cita: document.getElementById("fecha_cita"),
        correo: document.getElementById("correo")
      };

      form.style.display = "block";

      if (modo === "mi") {
        campos.nombre.value = pacienteData.nombre + " " + pacienteData.apellido;
        campos.fecha_nacimiento.value = pacienteData.fecha_nacimiento;
        campos.cedula.value = pacienteData.cedula;
        campos.telefono.value = pacienteData.telefono;
        campos.fecha_cita.value = pacienteData.fecha_cita;
        campos.correo.value = pacienteData.correo;

        for (let campo in campos) {
          if (campo !== "fecha_cita") {
            campos[campo].readOnly = true;
          } else {
            campos[campo].readOnly = false;
          }
        }

        campos.correo.setAttribute("readonly", true);
        campos.correo.removeAttribute("required");
        campoCorreoDiv.style.display = "block";

      } else {
        for (let campo in campos) {
          campos[campo].value = "";
          campos[campo].readOnly = false;
        }

        campos.correo.removeAttribute("readonly");
        campos.correo.setAttribute("required", true);
        campoCorreoDiv.style.display = "block";
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      var calendarEl = document.getElementById('calendar');

      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
        },
        events: '/api/citas/'
      });

      calendar.render();
    });
  </script>
</body>
</html>
